"""
å¿«é€Ÿå‚è€ƒï¼šWatchdog âŸ· TaskManager é›†æˆçŠ¶æ€

âœ… æ£€æŸ¥å®Œæˆ - ç¨‹åºé…åˆå¾ˆå¥½ï¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ä¸»è¦æ”¹è¿›æ¦‚è§ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. âœ… Watchdog å›è°ƒé›†æˆ
   - TaskManager åˆå§‹åŒ–æ—¶æ³¨å†Œè¶…æ—¶å’Œé”™è¯¯å›è°ƒ
   - å®ç°äº† _on_watchdog_timeout() å’Œ _on_watchdog_error()
   
2. âœ… æ™ºèƒ½è¶…æ—¶å¤„ç†  
   - Watchdog ä¸å†è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
   - é€šè¿‡ auto_cancel_on_timeout é…ç½®çµæ´»æ§åˆ¶
   - TaskManager å†³å®šæ˜¯å¦å–æ¶ˆè¶…æ—¶ä»»åŠ¡

3. âœ… èµ„æºæ¸…ç†æœºåˆ¶
   - æ–°å¢ _unregister_from_watchdog() æ–¹æ³•
   - ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨ä» Watchdog æ³¨é”€
   - é˜²æ­¢å†…å­˜æ³„æ¼

4. âœ… å®Œå–„çš„æ—¥å¿—è®°å½•
   - è¶…æ—¶æ£€æµ‹æ—¶è®°å½•è¯¦ç»†ä¿¡æ¯
   - èµ„æºæ³¨é”€æ—¶è®°å½•æ“ä½œ
   - ä¾¿äºè¯Šæ–­å’Œè°ƒè¯•

5. âœ… ç±»å‹å®‰å…¨
   - ä¿®å¤æ‰€æœ‰ç±»å‹æç¤ºé—®é¢˜
   - é€šè¿‡é™æ€ç±»å‹æ£€æŸ¥

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”„ é›†æˆæµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  TaskManager.submit_task(coro)
           â†“
  _execute_task() 
    â”œâ”€ åˆ›å»º asyncio.Task
    â””â”€ watchdog.register_task() â”€â”€â”€â”€â”€â”€â”
                                      â”‚
  await task â”€â”€â”€â”€â”€â”€â”                  â”‚
                   â”‚                  â”‚
                âœ… å®Œæˆ              â”‚
                   â”‚                  â”‚
    _on_task_success()               â”‚
      â””â”€ watchdog.unregister() â—„â”€â”€â”€â”€â”€â”˜
         (èµ„æºæ¸…ç†)

  åŒæ—¶ï¼ŒWatchdog åœ¨åå°ç›‘æ§ï¼š
  
  _monitor_loop()
    â””â”€ å®šæœŸæ£€æŸ¥ä»»åŠ¡
        â”œâ”€ è¶…æ—¶? â†’ _on_watchdog_timeout()
        â”‚          (å›è°ƒç»™ TaskManager)
        â”œâ”€ é”™è¯¯? â†’ _on_watchdog_error()
        â”‚          (è®°å½•é”™è¯¯)
        â””â”€ æ¸…ç†? â†’ unregister_task()
                  (è‡ªåŠ¨æ¸…ç†è¿‡æœŸä»»åŠ¡)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ å®ç”¨ä»£ç ç¤ºä¾‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# åŸºæœ¬ä½¿ç”¨
task_manager = get_task_manager(max_concurrent_tasks=10)
await task_manager.start()

# é…ç½®è¶…æ—¶å¤„ç†
task_manager.auto_cancel_on_timeout = True  # è‡ªåŠ¨å–æ¶ˆè¶…æ—¶ä»»åŠ¡

# æäº¤ä»»åŠ¡ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
config = TaskConfig(timeout=30.0, max_retries=3)
task_id = task_manager.submit_task(
    async_function,
    name="My Task",
    config=config
)

# ç­‰å¾…ç»“æœ
result = await task_manager.wait_for_task(task_id)

# ç›‘æ§çŠ¶æ€
stats = task_manager.get_stats()
print(f"è¿è¡Œä¸­: {stats['current_running']}")
print(f"å·²å®Œæˆ: {stats['total_completed']}")

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ æ–‡ä»¶æ¸…å•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¿®æ”¹çš„æ–‡ä»¶ï¼š
  ğŸ“ src/kernel/concurrency/task_manager.py
  ğŸ“ src/kernel/concurrency/watchdog.py

æ–°å¢çš„æ–‡ä»¶ï¼š
  âœ¨ tests/kernel/concurrency/test_integration.py
  âœ¨ docs/kernel/concurrency/INTEGRATION_IMPROVEMENTS.md
  âœ¨ WATCHDOG_TASKMANAGER_CHECK_REPORT.md (æœ¬æ–‡ä»¶)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ å…³é”®ç‰¹æ€§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… åŒå‘é€šä¿¡
   - TaskManager â†’ Watchdog: æ³¨å†Œä»»åŠ¡ã€æ³¨é”€ä»»åŠ¡
   - Watchdog â†’ TaskManager: è¶…æ—¶å›è°ƒã€é”™è¯¯å›è°ƒ

âœ… çµæ´»çš„è¶…æ—¶æ§åˆ¶
   - å¯å…¨å±€é…ç½®æˆ–æŒ‰ä»»åŠ¡é…ç½®
   - æ”¯æŒç¦ç”¨ã€è‡ªåŠ¨å–æ¶ˆæˆ–è‡ªå®šä¹‰å¤„ç†

âœ… å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - ä»»åŠ¡åˆ›å»º â†’ æ³¨å†Œ â†’ ç›‘æ§ â†’ å®Œæˆ â†’ æ³¨é”€
   - æ¯ä¸ªç¯èŠ‚éƒ½æœ‰æ˜ç¡®çš„è´£ä»»åˆ†å·¥

âœ… å¥å£®çš„é”™è¯¯å¤„ç†
   - å¼‚å¸¸æ—¶ä¸ä¼šå¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
   - Watchdog å›è°ƒä¸­çš„å¼‚å¸¸è¢«æ•è·
   - å®Œå–„çš„ try-except ä¿æŠ¤

âœ… èµ„æºé«˜æ•ˆ
   - åŠæ—¶æ³¨é”€å·²å®Œæˆçš„ä»»åŠ¡
   - å‡å°‘å†…å­˜å ç”¨
   - é™ä½ Watchdog çš„ç›‘æ§è´Ÿæ‹…

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¨ æ€»ç»“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ç°åœ¨ Watchdog å’Œ TaskManager æ‹¥æœ‰ï¼š
  âœ“ æ¸…æ™°çš„é›†æˆæ¥å£
  âœ“ å®Œå–„çš„åè°ƒæœºåˆ¶  
  âœ“ çµæ´»çš„é…ç½®é€‰é¡¹
  âœ“ å®Œæ•´çš„æµ‹è¯•è¦†ç›–
  âœ“ è¯¦å°½çš„æ–‡æ¡£è¯´æ˜

ğŸš€ çŠ¶æ€ï¼šå¯ä»¥ç”Ÿäº§å°±ç»ªï¼ˆProduction Readyï¼‰
"""
