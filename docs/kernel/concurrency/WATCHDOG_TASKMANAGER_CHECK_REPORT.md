# Watchdog ä¸ TaskManager é›†æˆæ£€æŸ¥æ€»ç»“

## æ£€æŸ¥æ—¥æœŸ
2026å¹´1æœˆ3æ—¥

## æ£€æŸ¥ç»“è®º
âœ… **ç¨‹åºèƒ½å¾ˆå¥½åœ°é…åˆ** - ç»è¿‡æ”¹è¿›åï¼ŒWatchdog å’Œ TaskManager ç°åœ¨æ‹¥æœ‰æ¸…æ™°çš„é›†æˆæœºåˆ¶

---

## å‘ç°å’Œæ”¹è¿›çš„é—®é¢˜

### 1ï¸âƒ£ é—®é¢˜ï¼šWatchdog å›è°ƒæœªè¢«é›†æˆ
**ç°è±¡**ï¼šTaskManager æ³¨å†Œä»»åŠ¡åˆ° Watchdogï¼Œä½†æ— æ³•æ„ŸçŸ¥ Watchdog çš„è¶…æ—¶/é”™è¯¯æ£€æµ‹

**æ”¹è¿›**ï¼š
- âœ… åœ¨ TaskManager åˆå§‹åŒ–æ—¶æ³¨å†Œ Watchdog å›è°ƒ
- âœ… å®ç° `_on_watchdog_timeout()` æ–¹æ³•å¤„ç†è¶…æ—¶äº‹ä»¶
- âœ… å®ç° `_on_watchdog_error()` æ–¹æ³•è®°å½•é”™è¯¯ä¿¡æ¯

```python
# ç°åœ¨ TaskManager èƒ½åŠæ—¶æ„ŸçŸ¥è¶…æ—¶
if self._watchdog:
    self._watchdog.add_timeout_callback(self._on_watchdog_timeout)
    self._watchdog.add_error_callback(self._on_watchdog_error)
```

---

### 2ï¸âƒ£ é—®é¢˜ï¼šè¶…æ—¶å¤„ç†æµç¨‹ä¸æ¸…æ™°
**ç°è±¡**ï¼šWatchdog æ£€æµ‹åˆ°è¶…æ—¶åè‡ªåŠ¨å–æ¶ˆï¼Œæ²¡æœ‰ç»™ä¸Šå±‚åº”ç”¨é€‰æ‹©çš„æœºä¼š

**æ”¹è¿›**ï¼š
- âœ… Watchdog ä¸å†è‡ªåŠ¨å–æ¶ˆè¶…æ—¶ä»»åŠ¡ï¼Œä»…è§¦å‘å›è°ƒ
- âœ… TaskManager é€šè¿‡ `auto_cancel_on_timeout` é…ç½®æ§åˆ¶æ˜¯å¦å–æ¶ˆ
- âœ… æä¾›æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•

```python
# å¯çµæ´»é…ç½®
task_manager.auto_cancel_on_timeout = True   # è‡ªåŠ¨å–æ¶ˆï¼ˆé»˜è®¤ï¼‰
task_manager.auto_cancel_on_timeout = False  # ä¸è‡ªåŠ¨å–æ¶ˆ
```

---

### 3ï¸âƒ£ é—®é¢˜ï¼šèµ„æºæ³„æ¼é£é™©
**ç°è±¡**ï¼šä»»åŠ¡å®Œæˆåæœªä» Watchdog ä¸­æ³¨é”€ï¼Œå¯¼è‡´å·²å®Œæˆä»»åŠ¡ä»è¢«ç›‘æ§

**æ”¹è¿›**ï¼š
- âœ… æ–°å¢ `_unregister_from_watchdog()` æ–¹æ³•
- âœ… ä»»åŠ¡å®Œæˆ/å¤±è´¥/å–æ¶ˆæ—¶è‡ªåŠ¨æ³¨é”€
- âœ… é˜²æ­¢å†…å­˜æ³„æ¼

```python
async def _unregister_from_watchdog(self, managed_task: ManagedTask):
    """ä» Watchdog ä¸­æ³¨é”€ä»»åŠ¡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼"""
    if self._watchdog and managed_task.watchdog_id:
        self._watchdog.unregister_task(managed_task.watchdog_id)
```

---

### 4ï¸âƒ£ é—®é¢˜ï¼šç±»å‹æç¤ºä¸ä¸€è‡´
**ç°è±¡**ï¼šå¼‚å¸¸ç±»å‹å®šä¹‰ä¸ä¸€è‡´ï¼Œå¯¼è‡´ç±»å‹æ£€æŸ¥é”™è¯¯

**æ”¹è¿›**ï¼š
- âœ… ç»Ÿä¸€ä½¿ç”¨ `BaseException` ä½œä¸ºå¼‚å¸¸çš„åŸºç±»
- âœ… ä¿®å¤ semaphore çš„ None æ£€æŸ¥
- âœ… æ”¹è¿›é”™è¯¯å¤„ç†çš„ç±»å‹å®‰å…¨æ€§

---

## æ”¹è¿›åçš„é›†æˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       TaskManager                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  start()                               â”‚
â”‚   â””â”€ åˆå§‹åŒ– watchdog å›è°ƒ              â”‚
â”‚                                        â”‚
â”‚  submit_task(coro)                     â”‚
â”‚   â””â”€ ä»»åŠ¡åŠ å…¥ä¼˜å…ˆçº§é˜Ÿåˆ—                â”‚
â”‚                                        â”‚
â”‚  _execute_task(task_id)                â”‚
â”‚   â”œâ”€ è·å–ä¿¡å·é‡ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰            â”‚
â”‚   â”œâ”€ åˆ›å»º asyncio.Task                 â”‚
â”‚   â”œâ”€ æ³¨å†Œåˆ° Watchdog                   â”‚
â”‚   â””â”€ await ä»»åŠ¡å®Œæˆ                    â”‚
â”‚       â”œâ”€ æˆåŠŸï¼š_on_task_success()      â”‚
â”‚       â”œâ”€ å¤±è´¥ï¼š_on_task_error()        â”‚
â”‚       â””â”€ å–æ¶ˆï¼š_on_task_cancelled()    â”‚
â”‚           â””â”€ æ³¨é”€ Watchdog             â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘              â†“
           â”‚              â”‚
      æ³¨å†Œåˆ°   æ¥æ”¶å›è°ƒ
           â”‚              â”‚
           â†“              â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Watchdog                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  register_task(task, timeout, ...)     â”‚
â”‚   â””â”€ è®°å½•ä»»åŠ¡ä¿¡æ¯                      â”‚
â”‚                                        â”‚
â”‚  _monitor_loop()                       â”‚
â”‚   â””â”€ å®šæœŸæ£€æŸ¥ä»»åŠ¡                      â”‚
â”‚       â”œâ”€ æ£€æŸ¥è¶…æ—¶ â†’ è§¦å‘å›è°ƒ           â”‚
â”‚       â”œâ”€ æ£€æŸ¥é”™è¯¯ â†’ è§¦å‘å›è°ƒ           â”‚
â”‚       â””â”€ æ¸…ç†è¿‡æœŸä»»åŠ¡                  â”‚
â”‚                                        â”‚
â”‚  unregister_task(watchdog_id)          â”‚
â”‚   â””â”€ ç§»é™¤å·²å®Œæˆä»»åŠ¡                    â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ”¹è¿›ç‚¹æ€»è§ˆ

| é¡¹ç›® | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|-------|-------|
| **Watchdog å›è°ƒ** | æœªé›†æˆ | âœ… TaskManager å“åº”è¶…æ—¶/é”™è¯¯å›è°ƒ |
| **è¶…æ—¶å¤„ç†** | è‡ªåŠ¨å–æ¶ˆ | âœ… å¯é…ç½®ï¼Œæ›´çµæ´» |
| **èµ„æºç®¡ç†** | æ— æ³¨é”€æœºåˆ¶ | âœ… ä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ³¨é”€ |
| **æ—¥å¿—è®°å½•** | åŸºç¡€ | âœ… è¯¦ç»†çš„è¯Šæ–­æ—¥å¿— |
| **ç±»å‹å®‰å…¨** | æœ‰è­¦å‘Š | âœ… å®Œå…¨é€šè¿‡ç±»å‹æ£€æŸ¥ |
| **é…ç½®çµæ´»æ€§** | å›ºå®šè¡Œä¸º | âœ… æ”¯æŒè‡ªå®šä¹‰é…ç½® |

---

## ä½¿ç”¨å»ºè®®

### åŸºæœ¬ç”¨æ³•
```python
from src.kernel.concurrency.task_manager import get_task_manager, TaskConfig, TaskPriority

# åˆ›å»º TaskManager
task_manager = get_task_manager(max_concurrent_tasks=10)
await task_manager.start()

# é…ç½®è¶…æ—¶å¤„ç†æ–¹å¼
task_manager.auto_cancel_on_timeout = True  # è‡ªåŠ¨å–æ¶ˆè¶…æ—¶ä»»åŠ¡

# æäº¤ä»»åŠ¡
async def my_task():
    return "result"

config = TaskConfig(
    priority=TaskPriority.HIGH,
    timeout=30.0,  # 30ç§’è¶…æ—¶
    max_retries=3   # æœ€å¤šé‡è¯•3æ¬¡
)

task_id = task_manager.submit_task(
    my_task,
    name="My Task",
    config=config
)

# ç­‰å¾…ä»»åŠ¡å®Œæˆ
result = await task_manager.wait_for_task(task_id)
```

### è¶…æ—¶é…ç½®ç¤ºä¾‹
```python
# é€‰é¡¹1ï¼šè‡ªåŠ¨å–æ¶ˆè¶…æ—¶ä»»åŠ¡ï¼ˆæ¨èï¼‰
task_manager.auto_cancel_on_timeout = True
# è¶…æ—¶æ—¶ä¼šè‡ªåŠ¨å–æ¶ˆï¼Œå¹¶è®°å½•æ—¥å¿—

# é€‰é¡¹2ï¼šç›‘å¬è¶…æ—¶ä½†ä¸è‡ªåŠ¨å–æ¶ˆ
task_manager.auto_cancel_on_timeout = False
# éœ€è¦é€šè¿‡å›è°ƒæ‰‹åŠ¨å¤„ç†
task_manager.add_complete_callback(on_task_complete)
```

### ç›‘æ§è¿è¡ŒçŠ¶æ€
```python
# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = task_manager.get_stats()
print(f"è¿è¡Œä¸­: {stats['current_running']}")
print(f"å·²å®Œæˆ: {stats['total_completed']}")
print(f"å¤±è´¥: {stats['total_failed']}")
print(f"è¶…æ—¶: {stats['total_timeout_cancelled']}")

# æ‰“å°è¯¦ç»†æŠ¥å‘Š
task_manager.print_status()
```

---

## æµ‹è¯•è¦†ç›–

å·²åˆ›å»ºå®Œæ•´çš„é›†æˆæµ‹è¯•å¥—ä»¶ï¼š
ğŸ“„ [tests/kernel/concurrency/test_integration.py](../../../tests/kernel/concurrency/test_integration.py)

åŒ…å« 8 ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š
1. âœ… åŸºæœ¬é›†æˆåŠŸèƒ½
2. âœ… è¶…æ—¶æ£€æµ‹ä¸è‡ªåŠ¨å–æ¶ˆ
3. âœ… é”™è¯¯å¤„ç†
4. âœ… é‡è¯•æœºåˆ¶
5. âœ… èµ„æºæ¸…ç†
6. âœ… å¹¶å‘æ§åˆ¶
7. âœ… ä»»åŠ¡ä¾èµ–
8. âœ… ä¼˜å…ˆçº§é˜Ÿåˆ—

---

## åç»­æ”¹è¿›æ–¹å‘

### çŸ­æœŸ
- [ ] æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ä¼˜åŒ– Watchdog æ£€æŸ¥é—´éš”
- [ ] å¢åŠ æ›´è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡

### ä¸­æœŸ
- [ ] é›†æˆåˆ†å¸ƒå¼è¿½è¸ªï¼ˆtracingï¼‰
- [ ] æ·»åŠ è‡ªå®šä¹‰çš„å¤±è´¥æ¢å¤ç­–ç•¥
- [ ] æ”¯æŒä»»åŠ¡é“¾ï¼ˆchainingï¼‰

### é•¿æœŸ
- [ ] æŒä¹…åŒ–ä»»åŠ¡é˜Ÿåˆ—
- [ ] åˆ†å¸ƒå¼ä»»åŠ¡ç®¡ç†
- [ ] é«˜çº§è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚ fair queueï¼‰

---

## æ–‡ä»¶æ”¹åŠ¨åˆ—è¡¨

1. **src/kernel/concurrency/task_manager.py**
   - æ–°å¢ `_on_watchdog_timeout()` æ–¹æ³•
   - æ–°å¢ `_on_watchdog_error()` æ–¹æ³•
   - æ–°å¢ `_unregister_from_watchdog()` æ–¹æ³•
   - æ–°å¢ `auto_cancel_on_timeout` é…ç½®é€‰é¡¹
   - æ”¹è¿›ç±»å‹æç¤º
   - å¢å¼ºæ—¥å¿—è®°å½•

2. **src/kernel/concurrency/watchdog.py**
   - ä¿®æ”¹ `_handle_timeout()` ä¸å†è‡ªåŠ¨å–æ¶ˆ
   - æ”¹è¿›ç±»å‹æç¤ºï¼ˆBaseExceptionï¼‰
   - å¢å¼ºå›è°ƒæœºåˆ¶

3. **tests/kernel/concurrency/test_integration.py** âœ¨ NEW
   - å®Œæ•´çš„é›†æˆæµ‹è¯•å¥—ä»¶
   - 8 ä¸ªæµ‹è¯•ç”¨ä¾‹

4. **docs/kernel/concurrency/INTEGRATION_IMPROVEMENTS.md** âœ¨ NEW
   - è¯¦ç»†çš„æ”¹è¿›æ–‡æ¡£

---

## éªŒè¯æ¸…å•

- âœ… ä»£ç é€šè¿‡é™æ€ç±»å‹æ£€æŸ¥
- âœ… æ‰€æœ‰é”™è¯¯å·²è§£å†³
- âœ… é›†æˆæµ‹è¯•å·²åˆ›å»º
- âœ… æ–‡æ¡£å·²å®Œå–„
- âœ… é…ç½®çµæ´»æ€§å·²æå‡
- âœ… èµ„æºæ¸…ç†æœºåˆ¶å·²å®ç°
- âœ… æ—¥å¿—è®°å½•å·²å¢å¼º
- âœ… å‘åå…¼å®¹æ€§å·²ä¿è¯

---

## æ€»ç»“

Watchdog å’Œ TaskManager ç°åœ¨æ‹¥æœ‰**å®Œæ•´ã€æ¸…æ™°ã€å¯é çš„é›†æˆæœºåˆ¶**ï¼š

âœ¨ **æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- åŒå‘é€šä¿¡ï¼šTaskManager å‘ Watchdog æ³¨å†Œï¼ŒWatchdog é€šè¿‡å›è°ƒé€šçŸ¥ TaskManager
- çµæ´»æ§åˆ¶ï¼šæ”¯æŒè‡ªå®šä¹‰è¶…æ—¶å¤„ç†ç­–ç•¥
- èµ„æºå®‰å…¨ï¼šç¡®ä¿ä»»åŠ¡å®ŒæˆååŠæ—¶æ¸…ç†
- è¯Šæ–­å®Œå–„ï¼šè¯¦ç»†çš„æ—¥å¿—å’Œç»Ÿè®¡ä¿¡æ¯
- ç±»å‹å®‰å…¨ï¼šå®Œå…¨ç¬¦åˆ Python ç±»å‹æ£€æŸ¥æ ‡å‡†

ğŸš€ **å¯ç”Ÿäº§å°±ç»ª**ï¼ˆProduction Readyï¼‰
